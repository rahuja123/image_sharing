{% extends "base.html" %}

{% block title %}Send - Photo Share{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Send Photo or Video</h1>
    <p>Send a disappearing photo or video to <strong>{{ recipient }}</strong></p>
</div>

<form method="POST" enctype="multipart/form-data" class="send-form">
    <div class="upload-area" id="upload-area">
        <div class="upload-icon">+</div>
        <p class="upload-text">Click to select a photo or video</p>
        <p class="upload-hint">or drag and drop</p>
        <input type="file" name="media" id="media-input" accept="image/*,video/*" required>
    </div>

    <div class="preview-container" id="preview-container" style="display: none;">
        <img id="preview-image" src="" alt="Preview" style="display: none;">
        <video id="preview-video" controls style="display: none;"></video>
        <div class="preview-buttons">
            <button type="button" class="btn btn-secondary" id="flip-btn" style="display: none;">Flip</button>
            <button type="button" class="btn btn-secondary" id="change-media">Change</button>
        </div>
    </div>

    <button type="submit" class="btn btn-primary btn-full" id="send-btn" disabled>Send</button>
</form>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('upload-area');
    const mediaInput = document.getElementById('media-input');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const previewVideo = document.getElementById('preview-video');
    const changeMediaBtn = document.getElementById('change-media');
    const flipBtn = document.getElementById('flip-btn');
    const sendBtn = document.getElementById('send-btn');
    const form = document.querySelector('.send-form');

    let isFlipped = false;
    let currentFileType = 'image/jpeg';

    uploadArea.addEventListener('click', () => mediaInput.click());

    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        if (e.dataTransfer.files.length) {
            mediaInput.files = e.dataTransfer.files;
            showPreview(e.dataTransfer.files[0]);
        }
    });

    mediaInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            showPreview(e.target.files[0]);
        }
    });

    changeMediaBtn.addEventListener('click', () => {
        mediaInput.value = '';
        previewContainer.style.display = 'none';
        previewImage.style.display = 'none';
        previewVideo.style.display = 'none';
        flipBtn.style.display = 'none';
        uploadArea.style.display = 'flex';
        sendBtn.disabled = true;
        isFlipped = false;
        previewImage.style.transform = 'scaleX(1)';
    });

    flipBtn.addEventListener('click', () => {
        isFlipped = !isFlipped;
        previewImage.style.transform = isFlipped ? 'scaleX(-1)' : 'scaleX(1)';
    });

    form.addEventListener('submit', async (e) => {
        if (isFlipped && previewImage.style.display !== 'none') {
            e.preventDefault();
            sendBtn.disabled = true;
            sendBtn.textContent = 'Processing...';

            try {
                const flippedBlob = await flipImageData(previewImage.src);
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(new File([flippedBlob], 'photo.jpg', { type: currentFileType }));
                mediaInput.files = dataTransfer.files;
                isFlipped = false;
                form.submit();
            } catch (err) {
                console.error('Error flipping image:', err);
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                form.submit();
            }
        }
    });

    function flipImageData(imageSrc) {
        return new Promise((resolve) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');
                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                ctx.drawImage(img, 0, 0);
                canvas.toBlob(resolve, currentFileType, 0.9);
            };
            img.src = imageSrc;
        });
    }

    function showPreview(file) {
        const isVideo = file.type.startsWith('video/');
        currentFileType = file.type || 'image/jpeg';
        const reader = new FileReader();

        reader.onload = (e) => {
            if (isVideo) {
                previewVideo.src = e.target.result;
                previewVideo.style.display = 'block';
                previewImage.style.display = 'none';
                flipBtn.style.display = 'none';
            } else {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                previewVideo.style.display = 'none';
                flipBtn.style.display = 'inline-block';
            }
            uploadArea.style.display = 'none';
            previewContainer.style.display = 'block';
            sendBtn.disabled = false;
            isFlipped = false;
            previewImage.style.transform = 'scaleX(1)';
        };
        reader.readAsDataURL(file);
    }
</script>
{% endblock %}
