{% extends "base.html" %}

{% block title %}Send - Photo Share{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Send Photo or Video</h1>
    <p>Send a disappearing photo or video to <strong>{{ recipient }}</strong></p>
</div>

<form method="POST" enctype="multipart/form-data" class="send-form" id="send-form">
    <!-- Initial choice: Camera or Gallery -->
    <div class="upload-area" id="upload-area">
        <div class="upload-buttons">
            <button type="button" class="btn btn-primary btn-full" id="open-camera-btn">Take Photo</button>
            <button type="button" class="btn btn-secondary btn-full" id="open-gallery-btn">Choose from Gallery</button>
        </div>
        <input type="file" name="media" id="media-input" accept="image/*,video/*" style="display: none;">
        <input type="hidden" name="flipped-media" id="flipped-media-input">
    </div>

    <!-- Camera View -->
    <div class="camera-container" id="camera-container" style="display: none;">
        <video id="camera-preview" autoplay playsinline></video>
        <div class="camera-controls">
            <button type="button" class="camera-btn" id="switch-camera-btn">Flip</button>
            <button type="button" class="camera-btn capture-btn" id="capture-btn"></button>
            <button type="button" class="camera-btn" id="close-camera-btn">X</button>
        </div>
        <div class="camera-indicator" id="camera-indicator">Front</div>
    </div>

    <!-- Preview -->
    <div class="preview-container" id="preview-container" style="display: none;">
        <img id="preview-image" src="" alt="Preview" style="display: none;">
        <video id="preview-video" controls style="display: none;"></video>
        <div class="preview-buttons">
            <button type="button" class="btn btn-secondary" id="change-media">Change</button>
        </div>
    </div>

    <button type="submit" class="btn btn-primary btn-full" id="send-btn" style="display: none;">Send</button>
</form>
{% endblock %}

{% block scripts %}
<script>
    const uploadArea = document.getElementById('upload-area');
    const mediaInput = document.getElementById('media-input');
    const previewContainer = document.getElementById('preview-container');
    const previewImage = document.getElementById('preview-image');
    const previewVideo = document.getElementById('preview-video');
    const changeMediaBtn = document.getElementById('change-media');
    const sendBtn = document.getElementById('send-btn');
    const form = document.getElementById('send-form');

    // Camera elements
    const cameraContainer = document.getElementById('camera-container');
    const cameraPreview = document.getElementById('camera-preview');
    const openCameraBtn = document.getElementById('open-camera-btn');
    const openGalleryBtn = document.getElementById('open-gallery-btn');
    const switchCameraBtn = document.getElementById('switch-camera-btn');
    const captureBtn = document.getElementById('capture-btn');
    const closeCameraBtn = document.getElementById('close-camera-btn');
    const cameraIndicator = document.getElementById('camera-indicator');

    let currentStream = null;
    let useFrontCamera = true;
    let capturedImageData = null;
    let isFromFrontCamera = false;

    // Open gallery (file picker)
    openGalleryBtn.addEventListener('click', () => {
        mediaInput.click();
    });

    // Handle gallery selection
    mediaInput.addEventListener('change', (e) => {
        if (e.target.files.length) {
            isFromFrontCamera = false;
            showPreview(e.target.files[0], false);
        }
    });

    // Open camera
    openCameraBtn.addEventListener('click', async () => {
        await startCamera();
    });

    // Switch between front and back camera
    switchCameraBtn.addEventListener('click', async () => {
        useFrontCamera = !useFrontCamera;
        await startCamera();
    });

    // Capture photo
    captureBtn.addEventListener('click', () => {
        capturePhoto();
    });

    // Close camera
    closeCameraBtn.addEventListener('click', () => {
        stopCamera();
        cameraContainer.style.display = 'none';
        uploadArea.style.display = 'block';
    });

    // Change media (go back)
    changeMediaBtn.addEventListener('click', () => {
        mediaInput.value = '';
        capturedImageData = null;
        previewContainer.style.display = 'none';
        previewImage.style.display = 'none';
        previewVideo.style.display = 'none';
        sendBtn.style.display = 'none';
        uploadArea.style.display = 'block';
    });

    async function startCamera() {
        stopCamera();

        try {
            const constraints = {
                video: {
                    facingMode: useFrontCamera ? 'user' : 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                },
                audio: false
            };

            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            cameraPreview.srcObject = currentStream;

            // Mirror preview for front camera (so it looks like a mirror)
            cameraPreview.style.transform = useFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
            cameraIndicator.textContent = useFrontCamera ? 'Front' : 'Back';

            uploadArea.style.display = 'none';
            cameraContainer.style.display = 'block';
        } catch (err) {
            console.error('Camera error:', err);
            alert('Could not access camera. Please use the gallery option.');
        }
    }

    function stopCamera() {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
    }

    function capturePhoto() {
        const canvas = document.createElement('canvas');
        canvas.width = cameraPreview.videoWidth;
        canvas.height = cameraPreview.videoHeight;
        const ctx = canvas.getContext('2d');

        // For front camera: flip the captured image so it looks natural (not mirrored)
        if (useFrontCamera) {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }

        ctx.drawImage(cameraPreview, 0, 0);

        isFromFrontCamera = useFrontCamera;
        capturedImageData = canvas.toDataURL('image/jpeg', 0.9);

        stopCamera();
        cameraContainer.style.display = 'none';

        // Show preview (already flipped correctly in the canvas)
        previewImage.src = capturedImageData;
        previewImage.style.display = 'block';
        previewImage.style.transform = 'scaleX(1)';
        previewVideo.style.display = 'none';
        previewContainer.style.display = 'block';
        sendBtn.style.display = 'block';
    }

    function showPreview(file, fromFrontCamera) {
        const isVideo = file.type.startsWith('video/');
        const reader = new FileReader();

        reader.onload = (e) => {
            if (isVideo) {
                previewVideo.src = e.target.result;
                previewVideo.style.display = 'block';
                previewImage.style.display = 'none';
            } else {
                previewImage.src = e.target.result;
                previewImage.style.display = 'block';
                previewImage.style.transform = 'scaleX(1)';
                previewVideo.style.display = 'none';
            }
            uploadArea.style.display = 'none';
            previewContainer.style.display = 'block';
            sendBtn.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Handle form submission
    form.addEventListener('submit', async (e) => {
        if (capturedImageData) {
            e.preventDefault();
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            try {
                // Convert base64 to blob
                const response = await fetch(capturedImageData);
                const blob = await response.blob();

                // Create file from blob
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(new File([blob], 'photo.jpg', { type: 'image/jpeg' }));
                mediaInput.files = dataTransfer.files;

                capturedImageData = null;
                form.submit();
            } catch (err) {
                console.error('Error processing image:', err);
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }
    });
</script>

<style>
    .upload-buttons {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        width: 100%;
    }

    .camera-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #000;
        z-index: 1000;
    }

    #camera-preview {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .camera-controls {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 2rem;
        padding-bottom: max(2rem, env(safe-area-inset-bottom));
        display: flex;
        justify-content: space-around;
        align-items: center;
        background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
    }

    .camera-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: #fff;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1rem;
        cursor: pointer;
    }

    .capture-btn {
        width: 70px;
        height: 70px;
        background: #fff;
        border: 4px solid rgba(255,255,255,0.5);
    }

    .capture-btn:active {
        transform: scale(0.95);
    }

    .camera-indicator {
        position: absolute;
        top: max(1rem, env(safe-area-inset-top));
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.5);
        color: #fff;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
    }
</style>
{% endblock %}
